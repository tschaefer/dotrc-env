#!/bin/bash

[ -n "$DISPLAY" ] && {
	exit 1
}

MACHINE_ID=$(cat /var/lib/dbus/machine-id)
DBUS_HOME="$HOME/.dbus"
SESSION_CONF="$DBUS_HOME/session.conf"
SESSION_HOME="$DBUS_HOME/session-bus"
SESSION_ID="$SESSION_HOME/${MACHINE_ID}-0"

case "$1" in
	launch)
		killall -0 -u $USER dbus-daemon 2>/dev/null
		[ $? -eq 0 ] && {
			exit 1
		}
		SESSION_ADDR=$(dbus-daemon --config-file=$SESSION_CONF --print-address)
		echo "DBUS_SESSION_BUS_ADDRESS=$SESSION_ADDR" > $SESSION_ID
		;;
	touchdown)
		killall -9 -u $USER dbus-daemon 2>/dev/null
		rm -f $SESSION_ID
		;;
	fuel)
		killall -0 -u $USER dbus-daemon 2>/dev/null
		[ $? -ne 0 ] && {
			exit 1
		}
		cat $SESSION_ID 2>/dev/null
		;;
	radio)
		killall -0 -u $USER dbus-daemon 2>/dev/null
		[ $? -eq 1 ] && {
			exit 1
		}
		;;
esac

exit 0
